<section
  class="ngx-json-treeview"
  [attr.role]="_currentDepth() === 0 ? 'tree' : null">
  @if (segments().length === 0) {
    <div [class]="primativeSegmentClass()">
      <span class="segment-primitive">
        {{ asString() }}
      </span>
    </div>
  } @else {
    @if (_currentDepth() === 0) {
      <span class="punctuation">{{ openingBrace() }}</span>
    }
    @for (
      segment of segments();
      track segment;
      let i = $index;
      let len = $count
    ) {
      @let needsComma = i < len - 1;
      @let expandable = isExpandable(segment);
      @let empty = isEmpty(segment);
      @let openingBrace = openingBraceForSegment(segment);
      @let closingBrace = closingBraceForSegment(segment);
      @let clickableValue = isClickable(segment);
      @let nodeId = id + '-node-label-' + _currentDepth() + '-' + i;

      <div
        [class]="'segment segment-type-' + segment.type"
        role="treeitem"
        [attr.aria-expanded]="expandable ? segment.expanded : undefined"
        [attr.aria-level]="_currentDepth() + 1"
        [attr.aria-setsize]="len"
        [attr.aria-posinset]="i + 1"
        [attr.aria-labelledby]="nodeId">
        <div class="segment-main">
          <button
            [id]="nodeId"
            type="button"
            [class.expandable]="expandable"
            [class.expanded]="segment.expanded"
            (click)="toggle(segment)"
            [disabled]="!expandable">
            @if (expandable) {
              <div class="toggler"></div>
            }
            @if (isArrayElement()) {
              <span class="segment-label">{{ segment.key }}</span>
            } @else {
              <span class="segment-key">{{ `"${segment.key}"` }}</span>
            }
          </button>
          <span
            [class.segment-label]="isArrayElement()"
            [class.punctuation]="!isArrayElement()"
            >:
          </span>
          @if (empty) {
            <span class="punctuation"
              >{{ openingBrace }}{{ closingBrace
              }}{{ needsComma ? ',' : '' }}</span
            >
          } @else if (!expandable || !segment.expanded) {
            <button
              type="button"
              [class.segment-label]="expandable"
              [class.segment-value]="!expandable"
              [class.clickable]="clickableValue"
              (click)="onValueClickHandler(segment)"
              [disabled]="!clickableValue">
              {{ segment.description }}
            </button>
            <span class="punctuation">{{ needsComma ? ',' : '' }}</span>
          } @else {
            <span class="punctuation">
              {{ openingBrace }}
            </span>
          }
        </div>
        @if (expandable && segment.expanded) {
          <div class="children" role="group">
            <ngx-json-treeview
              [json]="segment.value"
              [expanded]="expanded()"
              [depth]="depth()"
              [isClickableValue]="isClickableValue()"
              [enableClickableValues]="enableClickableValues()"
              [_parent]="segment"
              [_currentDepth]="_currentDepth() + 1"
              (onValueClick)="onValueClickHandler($event)" />
            <span class="punctuation">
              {{ closingBrace }}{{ needsComma ? ',' : '' }}
            </span>
          </div>
        }
      </div>
    }
    @if (_currentDepth() === 0) {
      <span class="punctuation">{{ closingBrace() }}</span>
    }
  }
</section>
